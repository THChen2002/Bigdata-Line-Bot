{% extends 'admin/base.html' %}
{% block title %}後台管理系統 - 數據分析{% endblock %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Pass users data from backend to JavaScript
    let usersData = JSON.parse('{{ users|tojson|safe }}');
    let adminUsers = JSON.parse('{{ admin_user_ids|tojson|safe }}');
    let liffId = '{{ liff_id }}';
</script>
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="{{ url_for('static', filename='js/admin/base.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/base.css') }}">
{% endblock %}
{% block content %}
<!-- LIFF Loading -->
<div id="liff-loading" class="d-flex justify-content-center align-items-center vh-100 flex-column">
    <div class="spinner-border text-success" role="status"></div>
    <p class="mt-3">正在驗證 LINE 登入，請稍候...</p>
</div>

<!-- Main Content (Hidden initially) -->
<div id="mainContent" class="d-none">
<!-- Analytics Dashboard View -->
<div id="dashboard-view" class="view active">
    <h2 class="mb-4">數據分析</h2>
    <div class="row g-4">
        <!-- Stat Cards -->
        <div class="col-xl-3 col-md-6">
            <div class="stat-card">
                <div class="stat-label">會員總數</div>
                <div class="stat-value text-primary" id="total-members-card">0</div>
            </div>
        </div>
            <div class="col-xl-3 col-md-6">
            <div class="stat-card">
                <div class="stat-label">非會員人數</div>
                <div class="stat-value text-secondary" id="non-members-card">0</div>
            </div>
        </div>
        <div class="col-xl-6 col-md-12">
            <div class="stat-card p-0 d-flex justify-content-around">
                <div class="text-center p-4">
                    <div class="stat-label">Lv1 請老師喝杯水</div>
                    <div class="stat-value" style="color:#0d6efd;" id="level1-card">0</div>
                </div>
                <div class="vr my-3"></div>
                <div class="text-center p-4">
                    <div class="stat-label">Lv2 請老師吃便當</div>
                    <div class="stat-value" style="color:#198754;" id="level2-card">0</div>
                </div>
                <div class="vr my-3"></div>
                <div class="text-center p-4">
                    <div class="stat-label">Lv3 請老師吃大餐</div>
                    <div class="stat-value" style="color:#ffc107;" id="level3-card">0</div>
                </div>
            </div>
        </div>
        <!-- Chart -->
        <div class="col-12">
            <div class="stat-card">
                <h5 class="mb-3 card-title">付費會員等級分佈</h5>
                <div style="height: 350px;">
                    <canvas id="membersChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Management View -->
<div id="users-view" class="view">
        <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">使用者管理</h2>
    </div>
    <div class="card">
        <div class="card-body">
            <!-- 搜尋功能 -->
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="searchInput" class="form-control"
                            placeholder="搜尋使用者ID、名稱...">
                    </div>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-secondary" id="filterButton">
                            <i class="bi bi-funnel me-1"></i>篩選
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="resetButton">
                            <i class="bi bi-arrow-repeat me-1"></i>重置
                        </button>
                    </div>
                </div>
            </div>
            <!-- 篩選面板 -->
            <div class="filter-panel" id="filterPanel">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <h6 class="mb-2">YT會員等級</h6>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="level0" value="0">
                                <label class="form-check-label" for="level0">無</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="level1" value="1">
                                <label class="form-check-label" for="level1">請老師喝杯水</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="level2" value="2">
                                <label class="form-check-label" for="level2">請老師吃便當</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="level3" value="3">
                                <label class="form-check-label" for="level3">請老師吃大餐</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <button type="button" class="btn btn-primary btn-sm" id="applyFilterBtn">套用篩選</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm"
                            id="closeFilterBtn">關閉</button>
                    </div>
                </div>
            </div>
            <!-- 已套用的篩選條件 -->
            <div id="activeFilters" class="mb-3" style="display: none;">
                <strong>篩選條件: </strong>
                <div class="d-inline-flex flex-wrap" id="filterBadges">
                </div>
            </div>
            <!-- 使用者列表 -->
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th data-sort="id">ID <span class="sort-icon"><i class="bi bi-sort-up"></i></span></th>
                            <th data-sort="userId">User ID <span class="sort-icon"></span></th>
                            <th data-sort="displayName">使用者名稱 <span class="sort-icon"></span></th>
                            <th data-sort="YtChannel">YT名稱 <span class="sort-icon"></span></th>
                            <th data-sort="ytLevel">YT會員等級 <span class="sort-icon"></span></th>
                            <th data-sort="joinAt">加入日期 <span class="sort-icon"></span></th>
                            <th>動作</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <!-- Rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</main>
</div>


<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
    <div class="modal-header">
        <h5 class="modal-title" id="editUserModalLabel"><i class="bi bi-pencil-square me-2"></i>編輯使用者</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body">
        <form id="editUserForm">
            <input type="hidden" id="editUserId">
            <div class="mb-3">
                <label for="editUserName" class="form-label">使用者名稱</label>
                <input type="text" class="form-control" id="editUserName" readonly>
            </div>
            <div class="mb-3">
                <label for="editUserIdField" class="form-label">User ID</label>
                <input type="text" class="form-control" id="editUserIdField" readonly>
            </div>
            <div class="mb-3">
                <label for="editYtChannel" class="form-label">YT名稱</label>
                <input type="text" class="form-control" id="editYtChannel">
            </div>
            <div class="mb-3">
                <label for="editYtLevel" class="form-label">YT會員等級</label>
                <select class="form-select" id="editYtLevel">
                    <option value="0">無</option>
                    <option value="1">等級 1 - 請老師喝杯水</option>
                    <option value="2">等級 2 - 請老師吃便當</option>
                    <option value="3">等級 3 - 請老師吃大餐</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="editJoinAt" class="form-label">註冊日期</label>
                <input type="date" class="form-control" id="editJoinAt">
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="saveUserBtn">儲存變更</button>
    </div>
</div>
</div>
</div>
</div> <!-- End of mainContent -->
{% endblock %}